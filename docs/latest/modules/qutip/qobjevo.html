


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>qutip.qobjevo &mdash; QuTiP 4.4 Documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> QuTiP: Quantum Toolbox in Python
          

          
          </a>

          
            
            
              <div class="version">
                4.4
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../frontmatter.html">Frontmatter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guide/guide.html">Users Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../apidoc/apidoc.html">API documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Change Log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributors.html">Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../biblio.html">Bibliography</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">QuTiP: Quantum Toolbox in Python</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>qutip.qobjevo</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for qutip.qobjevo</h1><div class="highlight"><pre>
<span></span><span class="c1"># This file is part of QuTiP: Quantum Toolbox in Python.</span>
<span class="c1">#</span>
<span class="c1">#    Copyright (c) 2011 and later, Paul D. Nation and Robert J. Johansson.</span>
<span class="c1">#    All rights reserved.</span>
<span class="c1">#</span>
<span class="c1">#    Redistribution and use in source and binary forms, with or without</span>
<span class="c1">#    modification, are permitted provided that the following conditions are</span>
<span class="c1">#    met:</span>
<span class="c1">#</span>
<span class="c1">#    1. Redistributions of source code must retain the above copyright notice,</span>
<span class="c1">#       this list of conditions and the following disclaimer.</span>
<span class="c1">#</span>
<span class="c1">#    2. Redistributions in binary form must reproduce the above copyright</span>
<span class="c1">#       notice, this list of conditions and the following disclaimer in the</span>
<span class="c1">#       documentation and/or other materials provided with the distribution.</span>
<span class="c1">#</span>
<span class="c1">#    3. Neither the name of the QuTiP: Quantum Toolbox in Python nor the names</span>
<span class="c1">#       of its contributors may be used to endorse or promote products derived</span>
<span class="c1">#       from this software without specific prior written permission.</span>
<span class="c1">#</span>
<span class="c1">#    THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span>
<span class="c1">#    &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<span class="c1">#    LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A</span>
<span class="c1">#    PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span>
<span class="c1">#    HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span>
<span class="c1">#    SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span>
<span class="c1">#    LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span>
<span class="c1">#    DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span>
<span class="c1">#    THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<span class="c1">#    (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span>
<span class="c1">#    OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="c1">###############################################################################</span>
<span class="sd">&quot;&quot;&quot;Time-dependent Quantum Object (Qobj) class.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;QobjEvo&#39;</span><span class="p">]</span>

<span class="kn">from</span> <span class="nn">qutip.qobj</span> <span class="k">import</span> <span class="n">Qobj</span>
<span class="kn">import</span> <span class="nn">qutip.settings</span> <span class="k">as</span> <span class="nn">qset</span>
<span class="kn">from</span> <span class="nn">qutip.interpolate</span> <span class="k">import</span> <span class="n">Cubic_Spline</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="k">import</span> <span class="n">CubicSpline</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">partial</span><span class="p">,</span> <span class="n">wraps</span>
<span class="kn">from</span> <span class="nn">types</span> <span class="k">import</span> <span class="n">FunctionType</span><span class="p">,</span> <span class="n">BuiltinFunctionType</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numbers</span> <span class="k">import</span> <span class="n">Number</span>
<span class="kn">from</span> <span class="nn">qutip.qobjevo_codegen</span> <span class="k">import</span> <span class="n">_compile_str_single</span><span class="p">,</span> <span class="n">_compiled_coeffs</span>
<span class="kn">from</span> <span class="nn">qutip.cy.spmatfuncs</span> <span class="k">import</span> <span class="p">(</span><span class="n">cy_expect_rho_vec</span><span class="p">,</span> <span class="n">cy_expect_psi</span><span class="p">,</span> <span class="n">spmv</span><span class="p">,</span> <span class="n">cy_spmm_tr</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">qutip.cy.cqobjevo</span> <span class="k">import</span> <span class="p">(</span><span class="n">CQobjCte</span><span class="p">,</span> <span class="n">CQobjCteDense</span><span class="p">,</span> <span class="n">CQobjEvoTd</span><span class="p">,</span>
                                 <span class="n">CQobjEvoTdMatched</span><span class="p">,</span> <span class="n">CQobjEvoTdDense</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">qutip.cy.cqobjevo_factor</span> <span class="k">import</span> <span class="p">(</span><span class="n">InterCoeffT</span><span class="p">,</span> <span class="n">InterCoeffCte</span><span class="p">,</span>
                                      <span class="n">InterpolateCoeff</span><span class="p">,</span> <span class="n">StrCoeff</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="k">if</span> <span class="n">qset</span><span class="o">.</span><span class="n">has_openmp</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">qutip.cy.openmp.cqobjevo_omp</span> <span class="k">import</span> <span class="p">(</span><span class="n">CQobjCteOmp</span><span class="p">,</span> <span class="n">CQobjEvoTdOmp</span><span class="p">,</span>
                                              <span class="n">CQobjEvoTdMatchedOmp</span><span class="p">)</span>

<span class="n">safePickle</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;win32&#39;</span><span class="p">:</span>
    <span class="n">safePickle</span> <span class="o">=</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">proj</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="o">+</span><span class="mi">0</span><span class="n">j</span>


<span class="n">str_env</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;sin&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">,</span>
    <span class="s2">&quot;cos&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">,</span>
    <span class="s2">&quot;tan&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">,</span>
    <span class="s2">&quot;asin&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">,</span>
    <span class="s2">&quot;acos&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">,</span>
    <span class="s2">&quot;atan&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">,</span>
    <span class="s2">&quot;pi&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span>
    <span class="s2">&quot;sinh&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sinh</span><span class="p">,</span>
    <span class="s2">&quot;cosh&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">cosh</span><span class="p">,</span>
    <span class="s2">&quot;tanh&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">tanh</span><span class="p">,</span>
    <span class="s2">&quot;asinh&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsinh</span><span class="p">,</span>
    <span class="s2">&quot;acosh&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arccosh</span><span class="p">,</span>
    <span class="s2">&quot;atanh&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arctanh</span><span class="p">,</span>
    <span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">,</span>
    <span class="s2">&quot;log&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">,</span>
    <span class="s2">&quot;log10&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">,</span>
    <span class="s2">&quot;erf&quot;</span><span class="p">:</span> <span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">erf</span><span class="p">,</span>
    <span class="s2">&quot;zerf&quot;</span><span class="p">:</span> <span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">erf</span><span class="p">,</span>
    <span class="s2">&quot;sqrt&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">,</span>
    <span class="s2">&quot;real&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">,</span>
    <span class="s2">&quot;imag&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span>
    <span class="s2">&quot;conj&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">,</span>
    <span class="s2">&quot;abs&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">,</span>
    <span class="s2">&quot;norm&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
    <span class="s2">&quot;arg&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">,</span>
    <span class="s2">&quot;proj&quot;</span><span class="p">:</span> <span class="n">proj</span><span class="p">,</span>
    <span class="s2">&quot;np&quot;</span><span class="p">:</span> <span class="n">np</span><span class="p">,</span>
    <span class="s2">&quot;spe&quot;</span><span class="p">:</span> <span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="p">}</span>

<span class="k">class</span> <span class="nc">_file_list</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Contain temp a list .pyx to clean</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">+=</span> <span class="p">[</span><span class="n">file_</span> <span class="o">+</span> <span class="s2">&quot;.pyx&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">file_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file_</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_</span><span class="p">):</span>
                <span class="c1"># Don&#39;t exist anymore</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>

<span class="n">coeff_files</span> <span class="o">=</span> <span class="n">_file_list</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">_StrWrapper</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="s2">&quot;_out = &quot;</span> <span class="o">+</span> <span class="n">code</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">{}):</span>
        <span class="n">env</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;t&quot;</span><span class="p">:</span> <span class="n">t</span><span class="p">}</span>
        <span class="n">env</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="n">exec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">str_env</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">env</span><span class="p">[</span><span class="s2">&quot;_out&quot;</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">_CubicSplineWrapper</span><span class="p">:</span>
    <span class="c1"># Using scipy&#39;s CubicSpline since Qutip&#39;s one</span>
    <span class="c1"># only accept linearly distributed tlist</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tlist</span><span class="p">,</span> <span class="n">coeff</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span> <span class="o">=</span> <span class="n">coeff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tlist</span> <span class="o">=</span> <span class="n">tlist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">CubicSpline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tlist</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">{}):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">([</span><span class="n">t</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">_StateAsArgs</span><span class="p">:</span>
    <span class="c1"># old with state (f(t, psi, args)) to new (args[&quot;state&quot;] = psi)</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coeff_func</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coeff_func</span> <span class="o">=</span> <span class="n">coeff_func</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">{}):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">coeff_func</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;_state_vec&quot;</span><span class="p">],</span> <span class="n">args</span><span class="p">)</span>


<span class="c1"># %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="c1"># object for each time dependent element of the QobjEvo</span>
<span class="c1"># qobj : the Qobj of element ([*Qobj*, f])</span>
<span class="c1"># get_coeff : a callable that take (t, args) and return the coeff at that t</span>
<span class="c1"># coeff : The coeff as a string, array or function as provided by the user.</span>
<span class="c1"># type : flag for the type of coeff</span>
<span class="k">class</span> <span class="nc">EvoElement</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qobj</span><span class="p">,</span> <span class="n">get_coeff</span><span class="p">,</span> <span class="n">coeff</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qobj</span> <span class="o">=</span> <span class="n">qobj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_coeff</span> <span class="o">=</span> <span class="n">get_coeff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span> <span class="o">=</span> <span class="n">coeff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">type</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">make</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">list_</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;self.qobj = list_[0]</span>
<span class="sd">        self.get_coeff = list_[1]</span>
<span class="sd">        self.coeff = list_[2]</span>
<span class="sd">        self.type = list_[3]&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">*</span><span class="n">list_</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">qobj</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_coeff</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span>


<div class="viewcode-block" id="QobjEvo"><a class="viewcode-back" href="../../apidoc/classes.html#qutip.QobjEvo">[docs]</a><span class="k">class</span> <span class="nc">QobjEvo</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A class for representing time-dependent quantum objects,</span>
<span class="sd">    such as quantum operators and states.</span>

<span class="sd">    The QobjEvo class is a representation of time-dependent Qutip quantum</span>
<span class="sd">    objects (Qobj). This class implements math operations :</span>
<span class="sd">        +,- : QobjEvo, Qobj</span>
<span class="sd">        * : Qobj, C-number</span>
<span class="sd">        / : C-number</span>
<span class="sd">    and some common linear operator/state operations. The QobjEvo</span>
<span class="sd">    are constructed from a nested list of Qobj with their time-dependent</span>
<span class="sd">    coefficients. The time-dependent coefficients are either a funciton, a</span>
<span class="sd">    string or a numpy array.</span>

<span class="sd">    For function format, the function signature must be f(t, args).</span>
<span class="sd">    *Examples*</span>
<span class="sd">        def f1_t(t, args):</span>
<span class="sd">            return np.exp(-1j * t * args[&quot;w1&quot;])</span>

<span class="sd">        def f2_t(t, args):</span>
<span class="sd">            return np.cos(t * args[&quot;w2&quot;])</span>

<span class="sd">        H = QobjEvo([H0, [H1, f1_t], [H2, f2_t]], args={&quot;w1&quot;:1., &quot;w2&quot;:2.})</span>

<span class="sd">    For string based coeffients, the string must be a compilable python code</span>
<span class="sd">    resulting in a complex. The following symbols are defined:</span>
<span class="sd">        sin cos tan asin acos atan pi</span>
<span class="sd">        sinh cosh tanh asinh acosh atanh</span>
<span class="sd">        exp log log10 erf zerf sqrt</span>
<span class="sd">        real imag conj abs norm arg proj</span>
<span class="sd">        numpy as np, and scipy.special as spe.</span>
<span class="sd">    *Examples*</span>
<span class="sd">        H = QobjEvo([H0, [H1, &#39;exp(-1j*w1*t)&#39;], [H2, &#39;cos(w2*t)&#39;]],</span>
<span class="sd">                    args={&quot;w1&quot;:1.,&quot;w2&quot;:2.})</span>

<span class="sd">    For numpy array format, the array must be an 1d of dtype float or complex.</span>
<span class="sd">    A list of times (float64) at which the coeffients must be given (tlist).</span>
<span class="sd">    The coeffients array must have the same len as the tlist.</span>
<span class="sd">    The time of the tlist do not need to be equidistant, but must be sorted.</span>
<span class="sd">    *Examples*</span>
<span class="sd">        tlist = np.logspace(-5,0,100)</span>
<span class="sd">        H = QobjEvo([H0, [H1, np.exp(-1j*tlist)], [H2, np.cos(2.*tlist)]],</span>
<span class="sd">                    tlist=tlist)</span>

<span class="sd">    args is a dict of (name:object). The name must be a valid variables string.</span>
<span class="sd">    Some solvers support arguments that update at each call:</span>
<span class="sd">    sesolve, mesolve, mcsolve:</span>
<span class="sd">        state can be obtained with:</span>
<span class="sd">            name+&quot;=vec&quot;:Qobj  =&gt; args[name] == state as 1D np.ndarray</span>
<span class="sd">            name+&quot;=mat&quot;:Qobj  =&gt; args[name] == state as 2D np.ndarray</span>
<span class="sd">            name+&quot;=Qobj&quot;:Qobj =&gt; args[name] == state as Qobj</span>

<span class="sd">            This Qobj is the initial value.</span>

<span class="sd">        expectation values:</span>
<span class="sd">            name+&quot;=expect&quot;:O (Qobj/QobjEvo)  =&gt; args[name] == expect(O, state)</span>
<span class="sd">            expect is &lt;phi|O|psi&gt; or tr(state * O) depending on state dimensions</span>

<span class="sd">    mcsolve:</span>
<span class="sd">        collapse can be obtained with:</span>
<span class="sd">            name+&quot;=collapse&quot;:list =&gt; args[name] == list of collapse</span>
<span class="sd">            each collapse will be appended to the list as (time, which c_ops)</span>

<span class="sd">    Mixing the formats is possible, but not recommended.</span>
<span class="sd">    Mixing tlist will cause problem.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    QobjEvo(Q_object=[], args={}, tlist=None)</span>

<span class="sd">    Q_object : array_like</span>
<span class="sd">        Data for vector/matrix representation of the quantum object.</span>

<span class="sd">    args : dictionary that contain the arguments for</span>

<span class="sd">    tlist : array_like</span>
<span class="sd">        List of times at which the numpy-array coefficients are applied. Times</span>
<span class="sd">        must be equidistant and start from 0.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    cte : Qobj</span>
<span class="sd">        Constant part of the QobjEvo</span>

<span class="sd">    ops : list</span>
<span class="sd">        List of Qobj and the coefficients.</span>
<span class="sd">        [(Qobj, coefficient as a function, original coefficient,</span>
<span class="sd">            type, local arguments ), ... ]</span>
<span class="sd">        type :</span>
<span class="sd">            1: function</span>
<span class="sd">            2: string</span>
<span class="sd">            3: np.array</span>
<span class="sd">            4: Cubic_Spline</span>

<span class="sd">    args : map</span>
<span class="sd">        arguments of the coefficients</span>

<span class="sd">    tlist : array_like</span>
<span class="sd">        List of times at which the numpy-array coefficients are applied.</span>

<span class="sd">    compiled : int</span>
<span class="sd">        Has the cython version of the QobjEvo been created</span>

<span class="sd">    compiled_qobjevo : cy_qobj (CQobjCte or CQobjEvoTd)</span>
<span class="sd">        Cython version of the QobjEvo</span>

<span class="sd">    dummy_cte : bool</span>
<span class="sd">        is self.cte a dummy Qobj</span>

<span class="sd">    const : bool</span>
<span class="sd">        Indicates if quantum object is Constant</span>

<span class="sd">    type : int</span>
<span class="sd">        information about the type of coefficient</span>
<span class="sd">            &quot;string&quot;, &quot;func&quot;, &quot;array&quot;,</span>
<span class="sd">            &quot;spline&quot;, &quot;mixed_callable&quot;, &quot;mixed_compilable&quot;</span>

<span class="sd">    num_obj : int</span>
<span class="sd">        number of Qobj in the QobjEvo : len(ops) + (1 if not dummy_cte)</span>


<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    copy() :</span>
<span class="sd">        Create copy of Qobj</span>

<span class="sd">    arguments(new_args):</span>
<span class="sd">        Update the args of the object</span>

<span class="sd">    Math:</span>
<span class="sd">        +/- QobjEvo, Qobj, scalar:</span>
<span class="sd">            Addition is possible between QobjEvo and with Qobj or scalar</span>
<span class="sd">        -:</span>
<span class="sd">            Negation operator</span>
<span class="sd">        * Qobj, scalar:</span>
<span class="sd">            Product is possible with Qobj or scalar</span>
<span class="sd">        / scalar:</span>
<span class="sd">            It is possible to divide by scalar only</span>
<span class="sd">    conj()</span>
<span class="sd">        Return the conjugate of quantum object.</span>

<span class="sd">    dag()</span>
<span class="sd">        Return the adjoint (dagger) of quantum object.</span>

<span class="sd">    trans()</span>
<span class="sd">        Return the transpose of quantum object.</span>

<span class="sd">    norm()</span>
<span class="sd">        Return self.dag() * self.</span>
<span class="sd">        Only possible if num_obj == 1</span>

<span class="sd">    permute(order)</span>
<span class="sd">        Returns composite qobj with indices reordered.</span>

<span class="sd">    ptrace(sel)</span>
<span class="sd">        Returns quantum object for selected dimensions after performing</span>
<span class="sd">        partial trace.</span>

<span class="sd">    apply(f, *args, **kw_args)</span>
<span class="sd">        Apply the function f to every Qobj. f(Qobj) -&gt; Qobj</span>
<span class="sd">        Return a modified QobjEvo and let the original one untouched</span>

<span class="sd">    apply_decorator(decorator, *args, str_mod=None,</span>
<span class="sd">                    inplace_np=False, **kw_args):</span>
<span class="sd">        Apply the decorator to each function of the ops.</span>
<span class="sd">        The *args and **kw_args are passed to the decorator.</span>
<span class="sd">        new_coeff_function = decorator(coeff_function, *args, **kw_args)</span>
<span class="sd">        str_mod : list of 2 elements</span>
<span class="sd">            replace the string : str_mod[0] + original_string + str_mod[1]</span>
<span class="sd">            *exemple: str_mod = [&quot;exp(&quot;,&quot;)&quot;]</span>
<span class="sd">        inplace_np:</span>
<span class="sd">            Change the numpy array instead of applying the decorator to the</span>
<span class="sd">            function reading the array. Some decorators create incorrect array.</span>
<span class="sd">            Transformations f&#39;(t) = f(g(t)) create a missmatch between the</span>
<span class="sd">            array and the associated time list.</span>

<span class="sd">    tidyup(atol=1e-12)</span>
<span class="sd">        Removes small elements from quantum object.</span>

<span class="sd">    compress():</span>
<span class="sd">        Merge ops which are based on the same quantum object and coeff type.</span>

<span class="sd">    compile(code=False, matched=False, dense=False, omp=0):</span>
<span class="sd">        Create the associated cython object for faster usage.</span>
<span class="sd">        code: return the code generated for compilation of the strings.</span>
<span class="sd">        matched: the compiled object use sparse matrix with matching indices.</span>
<span class="sd">                    (experimental, no real advantage)</span>
<span class="sd">        dense: the compiled object use dense matrix.</span>
<span class="sd">        omp: (int) number of thread: the compiled object use spmvpy_openmp.</span>

<span class="sd">    __call__(t, data=False, state=None, args={}):</span>
<span class="sd">        Return the Qobj at time t.</span>
<span class="sd">        *Faster after compilation</span>

<span class="sd">    mul_mat(t, mat):</span>
<span class="sd">        Product of this at t time with the dense matrix mat.</span>
<span class="sd">        *Faster after compilation</span>

<span class="sd">    mul_vec(t, psi):</span>
<span class="sd">        Apply the quantum object (if operator, no check) to psi.</span>
<span class="sd">        More generaly, return the product of the object at t with psi.</span>
<span class="sd">        *Faster after compilation</span>

<span class="sd">    expect(t, psi, herm=False):</span>
<span class="sd">        Calculates the expectation value for the quantum object (if operator,</span>
<span class="sd">            no check) and state psi.</span>
<span class="sd">        Return only the real part if herm.</span>
<span class="sd">        *Faster after compilation</span>

<span class="sd">    to_list():</span>
<span class="sd">        Return the time-dependent quantum object as a list</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Q_object</span><span class="o">=</span><span class="p">[],</span> <span class="n">args</span><span class="o">=</span><span class="p">{},</span> <span class="n">tlist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Q_object</span><span class="p">,</span> <span class="n">QobjEvo</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_inplace_copy</span><span class="p">(</span><span class="n">Q_object</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span> <span class="o">=</span> <span class="n">Q_object</span><span class="o">.</span><span class="vm">__dict__</span>
            <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">const</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dummy_cte</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">if</span> <span class="n">copy</span> <span class="k">else</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamics_args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cte</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tlist</span> <span class="o">=</span> <span class="n">tlist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compiled</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compiled_ptr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coeff_get</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">omp</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Q_object</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">Q_object</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Q_object</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Qobj</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Q_object</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                                <span class="p">(</span><span class="n">Qobj</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                <span class="c1"># The format is [Qobj, f/str]</span>
                <span class="n">Q_object</span> <span class="o">=</span> <span class="p">[</span><span class="n">Q_object</span><span class="p">]</span>

        <span class="n">op_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_td_format_check_single</span><span class="p">(</span><span class="n">Q_object</span><span class="p">,</span> <span class="n">tlist</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ops</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op_type</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">op_type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cte</span> <span class="o">=</span> <span class="n">Q_object</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">const</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s2">&quot;cte&quot;</span>
            <span class="k">elif</span> <span class="n">op_type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The Qobj must not already be a function&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op_type</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">op_type_count</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">type_</span><span class="p">,</span> <span class="n">op</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">op_type</span><span class="p">,</span> <span class="n">Q_object</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">type_</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cte</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cte</span> <span class="o">=</span> <span class="n">op</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cte</span> <span class="o">+=</span> <span class="n">op</span>
                <span class="k">elif</span> <span class="n">type_</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">op_type_count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">EvoElement</span><span class="p">(</span><span class="n">op</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">op</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">op</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;func&quot;</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">type_</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">op_type_count</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">EvoElement</span><span class="p">(</span><span class="n">op</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">_StrWrapper</span><span class="p">(</span><span class="n">op</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                                    <span class="n">op</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;string&quot;</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">type_</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">op_type_count</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">EvoElement</span><span class="p">(</span><span class="n">op</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">_CubicSplineWrapper</span><span class="p">(</span><span class="n">tlist</span><span class="p">,</span> <span class="n">op</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                                     <span class="n">op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="s2">&quot;array&quot;</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">type_</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="n">op_type_count</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">EvoElement</span><span class="p">(</span><span class="n">op</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">op</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">op</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;spline&quot;</span><span class="p">))</span>

            <span class="n">nops</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">op_type_count</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">op_type_count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">nops</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s2">&quot;func&quot;</span>
            <span class="k">elif</span> <span class="n">op_type_count</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">nops</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s2">&quot;string&quot;</span>
            <span class="k">elif</span> <span class="n">op_type_count</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">nops</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s2">&quot;array&quot;</span>
            <span class="k">elif</span> <span class="n">op_type_count</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">nops</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s2">&quot;spline&quot;</span>
            <span class="k">elif</span> <span class="n">op_type_count</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s2">&quot;mixed_callable&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s2">&quot;mixed_compilable&quot;</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cte</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cte</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">qobj</span>
                    <span class="c1"># test is all qobj are compatible (shape, dims)</span>
                    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cte</span> <span class="o">+=</span> <span class="n">op</span><span class="o">.</span><span class="n">qobj</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cte</span> <span class="o">*=</span> <span class="mf">0.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dummy_cte</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cte_copy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cte</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="c1"># test is all qobj are compatible (shape, dims)</span>
                    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">:</span>
                        <span class="n">cte_copy</span> <span class="o">+=</span> <span class="n">op</span><span class="o">.</span><span class="n">qobj</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Qobj not compatible.&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">const</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_obj</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dummy_cte</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_args_checks</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_td_format_check_single</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Q_object</span><span class="p">,</span> <span class="n">tlist</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">op_type</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Q_object</span><span class="p">,</span> <span class="n">Qobj</span><span class="p">):</span>
            <span class="n">op_type</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Q_object</span><span class="p">,</span> <span class="p">(</span><span class="n">FunctionType</span><span class="p">,</span>
                                   <span class="n">BuiltinFunctionType</span><span class="p">,</span> <span class="n">partial</span><span class="p">)):</span>
            <span class="n">op_type</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Q_object</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Q_object</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">op_type</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">for</span> <span class="n">op_k</span> <span class="ow">in</span> <span class="n">Q_object</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op_k</span><span class="p">,</span> <span class="n">Qobj</span><span class="p">):</span>
                    <span class="n">op_type</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op_k</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op_k</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Qobj</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Incorrect Q_object specification&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">op_k</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op_k</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">Cubic_Spline</span><span class="p">):</span>
                            <span class="n">op_type</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">callable</span><span class="p">(</span><span class="n">op_k</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                            <span class="n">op_type</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op_k</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                            <span class="n">op_type</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op_k</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tlist</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> \
                                        <span class="nb">len</span><span class="p">(</span><span class="n">op_k</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">tlist</span><span class="p">):</span>
                                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Time list does not match&quot;</span><span class="p">)</span>
                            <span class="n">op_type</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Incorrect Q_object specification&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Incorrect Q_object specification&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Incorrect Q_object specification&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">op_type</span>

    <span class="k">def</span> <span class="nf">_args_checks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">to_remove</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">to_add</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;=&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                <span class="n">name</span><span class="p">,</span> <span class="n">what</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">what</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Qobj&quot;</span><span class="p">,</span> <span class="s2">&quot;vec&quot;</span><span class="p">,</span> <span class="s2">&quot;mat&quot;</span><span class="p">]:</span>
                    <span class="c1"># state first, expect last</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">update</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dynamics_args</span> <span class="o">=</span> <span class="p">[(</span><span class="n">name</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamics_args</span>
                        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">Qobj</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;Qobj&quot;</span><span class="p">:</span>
                                    <span class="n">to_add</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                                <span class="k">elif</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;mat&quot;</span><span class="p">:</span>
                                    <span class="n">to_add</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">full</span><span class="p">()</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">to_add</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">full</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="s2">&quot;F&quot;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;Qobj&quot;</span><span class="p">:</span>
                                    <span class="n">to_add</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Qobj</span><span class="p">(</span><span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cte</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">]])</span>
                                <span class="k">elif</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;mat&quot;</span><span class="p">:</span>
                                    <span class="n">to_add</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">cte</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">to_add</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">cte</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

                <span class="k">elif</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;expect&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">QobjEvo</span><span class="p">):</span>
                        <span class="n">expect_op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">expect_op</span> <span class="o">=</span> <span class="n">QobjEvo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">update</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">ops</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamics_args</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                                <span class="n">ops</span> <span class="o">=</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">expect_op</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dynamics_args</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">name</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">expect_op</span><span class="p">)]</span>
                        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                            <span class="n">to_add</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Could not understand dynamics args: &quot;</span> <span class="o">+</span>
                                    <span class="n">what</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Supported dynamics args: &quot;</span>
                                    <span class="s2">&quot;Qobj, csr, vec, mat, expect&quot;</span><span class="p">)</span>
                <span class="n">to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">to_remove</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">to_add</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_old_with_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">add_vec</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;func&quot;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">op</span><span class="o">.</span><span class="n">get_coeff</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">nfunc</span> <span class="o">=</span> <span class="n">_StateAsArgs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coeff</span><span class="p">)</span>
                    <span class="n">op</span> <span class="o">=</span> <span class="n">EvoElement</span><span class="p">((</span><span class="n">op</span><span class="o">.</span><span class="n">qobj</span><span class="p">,</span> <span class="n">nfunc</span><span class="p">,</span> <span class="n">nfunc</span><span class="p">,</span> <span class="s2">&quot;func&quot;</span><span class="p">))</span>
                    <span class="n">add_vec</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">add_vec</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dynamics_args</span> <span class="o">+=</span> <span class="p">[(</span><span class="s2">&quot;_state_vec&quot;</span><span class="p">,</span> <span class="s2">&quot;vec&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># sometime not called</span>
        <span class="n">coeff_files</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">{}):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;t should be a real scalar.&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

        <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dynamics_args_update</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The new args must be in a dict&quot;</span><span class="p">)</span>
            <span class="n">old_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">old_compiled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiled</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compiled</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
            <span class="n">op_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">old_args</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compiled</span> <span class="o">=</span> <span class="n">old_compiled</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">op_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cte</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">op_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cte</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiled</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiled</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;dense&quot;</span><span class="p">:</span>
            <span class="n">op_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">op_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cte</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">:</span>
                <span class="n">op_t</span> <span class="o">+=</span> <span class="n">part</span><span class="o">.</span><span class="n">qobj</span><span class="o">.</span><span class="n">data</span> <span class="o">*</span> <span class="n">part</span><span class="o">.</span><span class="n">get_coeff</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">op_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cte</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">:</span>
                <span class="n">op_t</span> <span class="o">+=</span> <span class="n">part</span><span class="o">.</span><span class="n">qobj</span> <span class="o">*</span> <span class="n">part</span><span class="o">.</span><span class="n">get_coeff</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">op_t</span>

    <span class="k">def</span> <span class="nf">_dynamics_args_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">Qobj</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">op</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamics_args</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;vec&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">full</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="s2">&quot;F&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;mat&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">full</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;Qobj&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span>
                <span class="k">elif</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;expect&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">state</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">s1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cte</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">op</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamics_args</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;vec&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span>
                <span class="k">elif</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;expect&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">state</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">s1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cte</span><span class="o">.</span><span class="n">issuper</span><span class="p">:</span>
                    <span class="n">new_l</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">s1</span><span class="p">))</span>
                    <span class="n">mat</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">new_l</span><span class="p">,</span> <span class="n">new_l</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s2">&quot;F&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;mat&quot;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat</span>
                    <span class="k">elif</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;Qobj&quot;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Qobj</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cte</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">state</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">s1</span><span class="p">:</span>
                    <span class="n">mat</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;mat&quot;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat</span>
                    <span class="k">elif</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;Qobj&quot;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Qobj</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cte</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">]])</span>
                <span class="k">elif</span> <span class="n">state</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">s1</span><span class="o">*</span><span class="n">s1</span><span class="p">:</span>
                    <span class="n">new_l</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">s1</span><span class="p">))</span>
                    <span class="n">mat</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">new_l</span><span class="p">,</span> <span class="n">new_l</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s2">&quot;F&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;mat&quot;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat</span>
                    <span class="k">elif</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;Qobj&quot;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Qobj</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cte</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cte</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">state</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">s1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cte</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">new_l</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">s1</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">op</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamics_args</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;vec&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="s2">&quot;F&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;mat&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span>
                <span class="k">elif</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;expect&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">state</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Qobj</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cte</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">]])</span>
                <span class="k">elif</span> <span class="n">state</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">s1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Qobj</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cte</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Qobj</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;state must be a Qobj or np.ndarray&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">new</span> <span class="o">=</span> <span class="n">QobjEvo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cte</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="n">new</span><span class="o">.</span><span class="n">const</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span>
        <span class="n">new</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">new</span><span class="o">.</span><span class="n">dynamics_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamics_args</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">new</span><span class="o">.</span><span class="n">tlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tlist</span>
        <span class="n">new</span><span class="o">.</span><span class="n">dummy_cte</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dummy_cte</span>
        <span class="n">new</span><span class="o">.</span><span class="n">num_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_obj</span>
        <span class="n">new</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span>
        <span class="n">new</span><span class="o">.</span><span class="n">compiled</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">new</span><span class="o">.</span><span class="n">compiled_qobjevo</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">new</span><span class="o">.</span><span class="n">compiled_ptr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">new</span><span class="o">.</span><span class="n">coeff_get</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">new</span><span class="o">.</span><span class="n">coeff_files</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;array&quot;</span><span class="p">:</span>
                <span class="n">new_coeff</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">coeff</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_coeff</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">coeff</span>
            <span class="n">new</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">EvoElement</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">qobj</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">op</span><span class="o">.</span><span class="n">get_coeff</span><span class="p">,</span>
                                      <span class="n">new_coeff</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">type</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">new</span>

    <span class="k">def</span> <span class="nf">_inplace_copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cte</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">cte</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">const</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">const</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamics_args</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">dynamics_args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tlist</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">tlist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dummy_cte</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">dummy_cte</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_obj</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">num_obj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compiled</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compiled_ptr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coeff_get</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ops</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">ops</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;array&quot;</span><span class="p">:</span>
                <span class="n">new_coeff</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">coeff</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_coeff</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">coeff</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">EvoElement</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">qobj</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">op</span><span class="o">.</span><span class="n">get_coeff</span><span class="p">,</span>
                                       <span class="n">new_coeff</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">type</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The new args must be in a dict&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_args_checks</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiled</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiled</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s2">&quot;cte&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coeff_get</span><span class="p">,</span> <span class="n">StrCoeff</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coeff_get</span><span class="o">.</span><span class="n">set_args</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coeff_get</span><span class="o">.</span><span class="n">_set_dyn_args</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamics_args</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coeff_get</span><span class="p">,</span> <span class="n">_UnitedFuncCaller</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coeff_get</span><span class="o">.</span><span class="n">set_args</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamics_args</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">to_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">list_qobj</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dummy_cte</span><span class="p">:</span>
            <span class="n">list_qobj</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cte</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">:</span>
            <span class="n">list_qobj</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">op</span><span class="o">.</span><span class="n">qobj</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">coeff</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">list_qobj</span>

    <span class="c1"># Math function</span>
    <span class="k">def</span> <span class="nf">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">res</span> <span class="o">+=</span> <span class="n">other</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">__radd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">res</span> <span class="o">+=</span> <span class="n">other</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">__iadd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">QobjEvo</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cte</span> <span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">cte</span>
            <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">ops</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;array&quot;</span><span class="p">:</span>
                    <span class="n">new_coeff</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">coeff</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_coeff</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">coeff</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">EvoElement</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">qobj</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">op</span><span class="o">.</span><span class="n">get_coeff</span><span class="p">,</span>
                                           <span class="n">new_coeff</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">type</span><span class="p">))</span>
                <span class="n">l</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">other</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dynamics_args</span> <span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">dynamics_args</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">const</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span> <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">const</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dummy_cte</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dummy_cte</span> <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">dummy_cte</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">type</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;func&quot;</span><span class="p">,</span> <span class="s2">&quot;mixed_callable&quot;</span><span class="p">]</span> <span class="ow">or</span> \
                        <span class="n">other</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;func&quot;</span><span class="p">,</span> <span class="s2">&quot;mixed_callable&quot;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s2">&quot;mixed_callable&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s2">&quot;mixed_compilable&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compiled</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compiled_ptr</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coeff_get</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tlist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tlist</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">tlist</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">tlist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">tlist</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tlist</span><span class="p">)</span> <span class="ow">or</span> \
                        <span class="n">other</span><span class="o">.</span><span class="n">tlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;tlist are not compatible&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cte</span> <span class="o">+=</span> <span class="n">other</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dummy_cte</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">num_obj</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dummy_cte</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_type</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">res</span> <span class="o">-=</span> <span class="n">other</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">__rsub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">res</span> <span class="o">+=</span> <span class="n">other</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">__isub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="bp">self</span> <span class="o">+=</span> <span class="p">(</span><span class="o">-</span><span class="n">other</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">res</span> <span class="o">*=</span> <span class="n">other</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">__rmul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Qobj</span><span class="p">):</span>
            <span class="n">res</span><span class="o">.</span><span class="n">cte</span> <span class="o">=</span> <span class="n">other</span> <span class="o">*</span> <span class="n">res</span><span class="o">.</span><span class="n">cte</span>
            <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">ops</span><span class="p">:</span>
                <span class="n">op</span><span class="o">.</span><span class="n">qobj</span> <span class="o">=</span> <span class="n">other</span> <span class="o">*</span> <span class="n">op</span><span class="o">.</span><span class="n">qobj</span>
            <span class="k">return</span> <span class="n">res</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">*=</span> <span class="n">other</span>
            <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">__imul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Qobj</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Number</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cte</span> <span class="o">*=</span> <span class="n">other</span>
            <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">:</span>
                <span class="n">op</span><span class="o">.</span><span class="n">qobj</span> <span class="o">*=</span> <span class="n">other</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">QobjEvo</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">const</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cte</span> <span class="o">*=</span> <span class="n">other</span><span class="o">.</span><span class="n">cte</span>
                <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">:</span>
                    <span class="n">op</span><span class="o">.</span><span class="n">qobj</span> <span class="o">*=</span> <span class="n">other</span><span class="o">.</span><span class="n">cte</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">:</span>
                <span class="n">cte</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cte</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="bp">self</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cte</span> <span class="o">=</span> <span class="n">cte</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cte</span>
                <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">:</span>
                    <span class="n">op</span><span class="o">.</span><span class="n">qobj</span> <span class="o">=</span> <span class="n">cte</span><span class="o">*</span><span class="n">op</span><span class="o">.</span><span class="n">qobj</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cte</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cte</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cte</span> <span class="o">*=</span> <span class="n">other</span><span class="o">.</span><span class="n">cte</span>
                <span class="n">new_terms</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">old_ops</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ops</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">other</span><span class="o">.</span><span class="n">dummy_cte</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">old_ops</span><span class="p">:</span>
                        <span class="n">new_terms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ops_mul_cte</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">cte</span><span class="p">,</span> <span class="s2">&quot;R&quot;</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dummy_cte</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">ops</span><span class="p">:</span>
                        <span class="n">new_terms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ops_mul_cte</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">cte</span><span class="p">,</span> <span class="s2">&quot;L&quot;</span><span class="p">))</span>

                <span class="k">for</span> <span class="n">op_left</span> <span class="ow">in</span> <span class="n">old_ops</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">op_right</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">ops</span><span class="p">:</span>
                        <span class="n">new_terms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ops_mul_</span><span class="p">(</span><span class="n">op_left</span><span class="p">,</span>
                                                        <span class="n">op_right</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ops</span> <span class="o">=</span> <span class="n">new_terms</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dynamics_args</span> <span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">dynamics_args</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dummy_cte</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dummy_cte</span> <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">dummy_cte</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">num_obj</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">)</span> <span class="k">if</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">dummy_cte</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reset_type</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;QobjEvo can only be multiplied&quot;</span>
                            <span class="s2">&quot; with QobjEvo, Qobj or numbers&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__div__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span>
                              <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">complexfloating</span><span class="p">)):</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">res</span> <span class="o">*=</span> <span class="n">other</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">res</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Incompatible object for division&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__idiv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span>
                              <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">complexfloating</span><span class="p">)):</span>
            <span class="bp">self</span> <span class="o">*=</span> <span class="n">other</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Incompatible object for division&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__truediv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__div__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__neg__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">res</span><span class="o">.</span><span class="n">cte</span> <span class="o">=</span> <span class="o">-</span><span class="n">res</span><span class="o">.</span><span class="n">cte</span>
        <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">ops</span><span class="p">:</span>
            <span class="n">op</span><span class="o">.</span><span class="n">qobj</span> <span class="o">=</span> <span class="o">-</span><span class="n">op</span><span class="o">.</span><span class="n">qobj</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">_ops_mul_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opL</span><span class="p">,</span> <span class="n">opR</span><span class="p">):</span>
        <span class="n">new_f</span> <span class="o">=</span> <span class="n">_Prod</span><span class="p">(</span><span class="n">opL</span><span class="o">.</span><span class="n">get_coeff</span><span class="p">,</span> <span class="n">opR</span><span class="o">.</span><span class="n">get_coeff</span><span class="p">)</span>
        <span class="n">new_op</span> <span class="o">=</span> <span class="p">[</span><span class="n">opL</span><span class="o">.</span><span class="n">qobj</span><span class="o">*</span><span class="n">opR</span><span class="o">.</span><span class="n">qobj</span><span class="p">,</span> <span class="n">new_f</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">opL</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">opR</span><span class="o">.</span><span class="n">type</span> <span class="ow">and</span> <span class="n">opL</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;string&quot;</span><span class="p">:</span>
            <span class="n">new_op</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="n">opL</span><span class="o">.</span><span class="n">coeff</span> <span class="o">+</span> <span class="s2">&quot;) * (&quot;</span> <span class="o">+</span> <span class="n">opR</span><span class="o">.</span><span class="n">coeff</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
            <span class="n">new_op</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;string&quot;</span>
        <span class="k">elif</span> <span class="n">opL</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">opR</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="ow">and</span> <span class="n">opL</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;array&quot;</span><span class="p">:</span>
            <span class="n">new_op</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">opL</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">opR</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">new_op</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;array&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_op</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_f</span>
            <span class="n">new_op</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;func&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;func&quot;</span><span class="p">,</span> <span class="s2">&quot;mixed_callable&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s2">&quot;mixed_callable&quot;</span>
        <span class="k">return</span> <span class="n">EvoElement</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="n">new_op</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ops_mul_cte</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">cte</span><span class="p">,</span> <span class="n">side</span><span class="p">):</span>
        <span class="n">new_op</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">get_coeff</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">coeff</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">type</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">side</span> <span class="o">==</span> <span class="s2">&quot;R&quot;</span><span class="p">:</span>
            <span class="n">new_op</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">qobj</span> <span class="o">*</span> <span class="n">cte</span>
        <span class="k">if</span> <span class="n">side</span> <span class="o">==</span> <span class="s2">&quot;L&quot;</span><span class="p">:</span>
            <span class="n">new_op</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cte</span> <span class="o">*</span> <span class="n">op</span><span class="o">.</span><span class="n">qobj</span>
        <span class="k">return</span> <span class="n">EvoElement</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="n">new_op</span><span class="p">)</span>

    <span class="c1"># Transformations</span>
    <span class="k">def</span> <span class="nf">trans</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">res</span><span class="o">.</span><span class="n">cte</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">cte</span><span class="o">.</span><span class="n">trans</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">ops</span><span class="p">:</span>
            <span class="n">op</span><span class="o">.</span><span class="n">qobj</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">qobj</span><span class="o">.</span><span class="n">trans</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">conj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">res</span><span class="o">.</span><span class="n">cte</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">cte</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">ops</span><span class="p">:</span>
            <span class="n">op</span><span class="o">.</span><span class="n">qobj</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">qobj</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
        <span class="n">res</span><span class="o">.</span><span class="n">_f_conj</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">dag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">res</span><span class="o">.</span><span class="n">cte</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">cte</span><span class="o">.</span><span class="n">dag</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">ops</span><span class="p">:</span>
            <span class="n">op</span><span class="o">.</span><span class="n">qobj</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">qobj</span><span class="o">.</span><span class="n">dag</span><span class="p">()</span>
        <span class="n">res</span><span class="o">.</span><span class="n">_f_conj</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">_cdc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return a.dag * a &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_obj</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dag</span><span class="p">()</span>
            <span class="n">res</span> <span class="o">*=</span> <span class="bp">self</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">res</span><span class="o">.</span><span class="n">cte</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">cte</span><span class="o">.</span><span class="n">dag</span><span class="p">()</span> <span class="o">*</span> <span class="n">res</span><span class="o">.</span><span class="n">cte</span>
            <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">ops</span><span class="p">:</span>
                <span class="n">op</span><span class="o">.</span><span class="n">qobj</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">qobj</span><span class="o">.</span><span class="n">dag</span><span class="p">()</span> <span class="o">*</span> <span class="n">op</span><span class="o">.</span><span class="n">qobj</span>
            <span class="n">res</span><span class="o">.</span><span class="n">_f_norm2</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="c1"># Unitary function of Qobj</span>
    <span class="k">def</span> <span class="nf">tidyup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cte</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cte</span><span class="o">.</span><span class="n">tidyup</span><span class="p">(</span><span class="n">atol</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">:</span>
            <span class="n">op</span><span class="o">.</span><span class="n">qobj</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">qobj</span><span class="o">.</span><span class="n">tidyup</span><span class="p">(</span><span class="n">atol</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">_compress_make_set</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">callable_flags</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;func&quot;</span><span class="p">,</span> <span class="s2">&quot;spline&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">op1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">):</span>
            <span class="n">already_matched</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">_set</span> <span class="ow">in</span> <span class="n">sets</span><span class="p">:</span>
                <span class="n">already_matched</span> <span class="o">=</span> <span class="n">already_matched</span> <span class="ow">or</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">_set</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">already_matched</span><span class="p">:</span>
                <span class="n">this_set</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">op2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]):</span>
                    <span class="k">if</span> <span class="n">op1</span><span class="o">.</span><span class="n">qobj</span> <span class="o">==</span> <span class="n">op2</span><span class="o">.</span><span class="n">qobj</span><span class="p">:</span>
                        <span class="n">same_flag</span> <span class="o">=</span> <span class="n">op1</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">op2</span><span class="o">.</span><span class="n">type</span>
                        <span class="n">callable_1</span> <span class="o">=</span> <span class="n">op1</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="n">callable_flags</span>
                        <span class="n">callable_2</span> <span class="o">=</span> <span class="n">op2</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="n">callable_flags</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">same_flag</span> <span class="ow">or</span> <span class="p">(</span><span class="n">callable_1</span> <span class="ow">and</span> <span class="n">callable_2</span><span class="p">)):</span>
                            <span class="n">this_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">sets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_set</span><span class="p">)</span>

        <span class="n">fsets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">op1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">):</span>
            <span class="n">already_matched</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">_set</span> <span class="ow">in</span> <span class="n">fsets</span><span class="p">:</span>
                <span class="n">already_matched</span> <span class="o">=</span> <span class="n">already_matched</span> <span class="ow">or</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">_set</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">already_matched</span><span class="p">:</span>
                <span class="n">this_set</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">op2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]):</span>
                    <span class="k">if</span> <span class="n">op1</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">op2</span><span class="o">.</span><span class="n">type</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">elif</span> <span class="n">op1</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="s2">&quot;array&quot;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">op1</span><span class="o">.</span><span class="n">coeff</span><span class="p">,</span> <span class="n">op2</span><span class="o">.</span><span class="n">coeff</span><span class="p">):</span>
                            <span class="n">this_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">op1</span><span class="o">.</span><span class="n">coeff</span> <span class="ow">is</span> <span class="n">op2</span><span class="o">.</span><span class="n">coeff</span><span class="p">:</span>
                            <span class="n">this_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">fsets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_set</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sets</span><span class="p">,</span> <span class="n">fsets</span>

    <span class="k">def</span> <span class="nf">_compress_merge_qobj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sets</span><span class="p">):</span>
        <span class="n">callable_flags</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;func&quot;</span><span class="p">,</span> <span class="s2">&quot;spline&quot;</span><span class="p">]</span>
        <span class="n">new_ops</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_set</span> <span class="ow">in</span> <span class="n">sets</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_set</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">new_ops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="n">_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="n">_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="n">callable_flags</span><span class="p">:</span>
                <span class="n">new_op</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="n">_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">qobj</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;func&quot;</span><span class="p">]</span>
                <span class="n">fs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">_set</span><span class="p">:</span>
                    <span class="n">fs</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_coeff</span><span class="p">]</span>
                <span class="n">new_op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">_Add</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span>
                <span class="n">new_op</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">new_ops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">EvoElement</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="n">new_op</span><span class="p">))</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="n">_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="s2">&quot;string&quot;</span><span class="p">:</span>
                <span class="n">new_op</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="n">_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">qobj</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;string&quot;</span><span class="p">]</span>
                <span class="n">new_str</span> <span class="o">=</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="n">_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">coeff</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">_set</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                    <span class="n">new_str</span> <span class="o">+=</span> <span class="s2">&quot; + (&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">coeff</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
                <span class="n">new_op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">_StrWrapper</span><span class="p">(</span><span class="n">new_str</span><span class="p">)</span>
                <span class="n">new_op</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_str</span>
                <span class="n">new_ops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">EvoElement</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="n">new_op</span><span class="p">))</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="n">_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="s2">&quot;array&quot;</span><span class="p">:</span>
                <span class="n">new_op</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="n">_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">qobj</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;array&quot;</span><span class="p">]</span>
                <span class="n">new_array</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="n">_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">coeff</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">_set</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                    <span class="n">new_array</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">coeff</span>
                <span class="n">new_op</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_array</span>
                <span class="n">new_op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">_CubicSplineWrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tlist</span><span class="p">,</span> <span class="n">new_array</span><span class="p">)</span>
                <span class="n">new_ops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">EvoElement</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="n">new_op</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ops</span> <span class="o">=</span> <span class="n">new_ops</span>

    <span class="k">def</span> <span class="nf">_compress_merge_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fsets</span><span class="p">):</span>
        <span class="n">new_ops</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_set</span> <span class="ow">in</span> <span class="n">fsets</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="n">_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">new_op</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">base</span><span class="o">.</span><span class="n">get_coeff</span><span class="p">,</span> <span class="n">base</span><span class="o">.</span><span class="n">coeff</span><span class="p">,</span> <span class="n">base</span><span class="o">.</span><span class="n">type</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_set</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">new_op</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">qobj</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_op</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">qobj</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">_set</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                    <span class="n">new_op</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">qobj</span>
            <span class="n">new_ops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">EvoElement</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="n">new_op</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ops</span> <span class="o">=</span> <span class="n">new_ops</span>

    <span class="k">def</span> <span class="nf">compress</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tidyup</span><span class="p">()</span>
        <span class="n">sets</span><span class="p">,</span> <span class="n">fsets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compress_make_set</span><span class="p">()</span>
        <span class="n">N_sets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sets</span><span class="p">)</span>
        <span class="n">N_fsets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fsets</span><span class="p">)</span>
        <span class="n">num_ops</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">N_sets</span> <span class="o">&lt;</span> <span class="n">num_ops</span> <span class="ow">and</span> <span class="n">N_fsets</span> <span class="o">&lt;</span> <span class="n">num_ops</span><span class="p">:</span>
            <span class="c1"># Both could be better</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compiled</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coeff_get</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">N_sets</span> <span class="o">&lt;</span> <span class="n">N_fsets</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_compress_merge_qobj</span><span class="p">(</span><span class="n">sets</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_compress_merge_func</span><span class="p">(</span><span class="n">fsets</span><span class="p">)</span>
            <span class="n">sets</span><span class="p">,</span> <span class="n">fsets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compress_make_set</span><span class="p">()</span>
            <span class="n">N_sets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sets</span><span class="p">)</span>
            <span class="n">N_fsets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fsets</span><span class="p">)</span>
            <span class="n">num_ops</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">N_sets</span> <span class="o">&lt;</span> <span class="n">num_ops</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compiled</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coeff_get</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_compress_merge_qobj</span><span class="p">(</span><span class="n">sets</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">N_fsets</span> <span class="o">&lt;</span> <span class="n">num_ops</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compiled</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coeff_get</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_compress_merge_func</span><span class="p">(</span><span class="n">fsets</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_type</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_reset_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">op_type_count</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;func&quot;</span><span class="p">:</span>
                <span class="n">op_type_count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">op</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;string&quot;</span><span class="p">:</span>
                <span class="n">op_type_count</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">op</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;array&quot;</span><span class="p">:</span>
                <span class="n">op_type_count</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">op</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;spline&quot;</span><span class="p">:</span>
                <span class="n">op_type_count</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">nops</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">op_type_count</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">op_type_count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">nops</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s2">&quot;func&quot;</span>
        <span class="k">elif</span> <span class="n">op_type_count</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">nops</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s2">&quot;string&quot;</span>
        <span class="k">elif</span> <span class="n">op_type_count</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">nops</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s2">&quot;array&quot;</span>
        <span class="k">elif</span> <span class="n">op_type_count</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">nops</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s2">&quot;spline&quot;</span>
        <span class="k">elif</span> <span class="n">op_type_count</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s2">&quot;mixed_callable&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s2">&quot;mixed_compilable&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">num_obj</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dummy_cte</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">permute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">res</span><span class="o">.</span><span class="n">cte</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">cte</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">ops</span><span class="p">:</span>
            <span class="n">op</span><span class="o">.</span><span class="n">qobj</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">qobj</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">ptrace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sel</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">res</span><span class="o">.</span><span class="n">cte</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">cte</span><span class="o">.</span><span class="n">ptrace</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">ops</span><span class="p">:</span>
            <span class="n">op</span><span class="o">.</span><span class="n">qobj</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">qobj</span><span class="o">.</span><span class="n">ptrace</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="c1"># function to apply custom transformations</span>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw_args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compiled</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">cte_res</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">cte</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw_args</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cte_res</span><span class="p">,</span> <span class="n">Qobj</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The function must return a Qobj&quot;</span><span class="p">)</span>
        <span class="n">res</span><span class="o">.</span><span class="n">cte</span> <span class="o">=</span> <span class="n">cte_res</span>
        <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">ops</span><span class="p">:</span>
            <span class="n">op</span><span class="o">.</span><span class="n">qobj</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">qobj</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw_args</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">apply_decorator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw_args</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;str_mod&quot;</span> <span class="ow">in</span> <span class="n">kw_args</span><span class="p">:</span>
            <span class="n">str_mod</span> <span class="o">=</span> <span class="n">kw_args</span><span class="p">[</span><span class="s2">&quot;str_mod&quot;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">kw_args</span><span class="p">[</span><span class="s2">&quot;str_mod&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">str_mod</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s2">&quot;inplace_np&quot;</span> <span class="ow">in</span> <span class="n">kw_args</span><span class="p">:</span>
            <span class="n">inplace_np</span> <span class="o">=</span> <span class="n">kw_args</span><span class="p">[</span><span class="s2">&quot;inplace_np&quot;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">kw_args</span><span class="p">[</span><span class="s2">&quot;inplace_np&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">inplace_np</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">ops</span><span class="p">:</span>
            <span class="n">op</span><span class="o">.</span><span class="n">get_coeff</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">get_coeff</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw_args</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;func&quot;</span><span class="p">,</span> <span class="s2">&quot;spline&quot;</span><span class="p">]:</span>
                <span class="n">op</span><span class="o">.</span><span class="n">coeff</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">get_coeff</span>
                <span class="n">op</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s2">&quot;func&quot;</span>
            <span class="k">elif</span> <span class="n">op</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;string&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">str_mod</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">op</span><span class="o">.</span><span class="n">coeff</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">get_coeff</span>
                    <span class="n">op</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s2">&quot;func&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">op</span><span class="o">.</span><span class="n">coeff</span> <span class="o">=</span> <span class="n">str_mod</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">op</span><span class="o">.</span><span class="n">coeff</span> <span class="o">+</span> <span class="n">str_mod</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">op</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;array&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">inplace_np</span><span class="p">:</span>
                    <span class="c1"># keep the original function, change the array</span>
                    <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
                        <span class="k">return</span> <span class="n">a</span>
                    <span class="n">ff</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw_args</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">coeff</span><span class="p">):</span>
                        <span class="n">op</span><span class="o">.</span><span class="n">coeff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ff</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="n">op</span><span class="o">.</span><span class="n">get_coeff</span> <span class="o">=</span> <span class="n">_CubicSplineWrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tlist</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">coeff</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">op</span><span class="o">.</span><span class="n">coeff</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">get_coeff</span>
                    <span class="n">op</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s2">&quot;func&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;string&quot;</span> <span class="ow">and</span> <span class="n">str_mod</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s2">&quot;mixed_callable&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;array&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">inplace_np</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s2">&quot;mixed_callable&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;spline&quot;</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s2">&quot;mixed_callable&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;mixed_compilable&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">ops</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;func&quot;</span><span class="p">:</span>
                    <span class="n">res</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s2">&quot;mixed_callable&quot;</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">_f_norm2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">new_ops</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">:</span>
            <span class="n">new_op</span> <span class="o">=</span> <span class="p">[</span><span class="n">op</span><span class="o">.</span><span class="n">qobj</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">type</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;func&quot;</span><span class="p">:</span>
                <span class="n">new_op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">_Norm2</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">get_coeff</span><span class="p">)</span>
                <span class="n">new_op</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">op</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;string&quot;</span><span class="p">:</span>
                <span class="n">new_op</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;norm(&quot;</span> <span class="o">+</span> <span class="n">op</span><span class="o">.</span><span class="n">coeff</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
                <span class="n">new_op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">_StrWrapper</span><span class="p">(</span><span class="n">new_op</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">op</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;array&quot;</span><span class="p">:</span>
                <span class="n">new_op</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">coeff</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
                <span class="n">new_op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">_CubicSplineWrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tlist</span><span class="p">,</span> <span class="n">new_op</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">op</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;spline&quot;</span><span class="p">:</span>
                <span class="n">new_op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">_Norm2</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">get_coeff</span><span class="p">)</span>
                <span class="n">new_op</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">new_op</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;func&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s2">&quot;mixed_callable&quot;</span>
            <span class="n">new_ops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">EvoElement</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="n">new_op</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ops</span> <span class="o">=</span> <span class="n">new_ops</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">_f_conj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">new_ops</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">:</span>
            <span class="n">new_op</span> <span class="o">=</span> <span class="p">[</span><span class="n">op</span><span class="o">.</span><span class="n">qobj</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">type</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;func&quot;</span><span class="p">:</span>
                <span class="n">new_op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">_Conj</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">get_coeff</span><span class="p">)</span>
                <span class="n">new_op</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">op</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;string&quot;</span><span class="p">:</span>
                <span class="n">new_op</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;conj(&quot;</span> <span class="o">+</span> <span class="n">op</span><span class="o">.</span><span class="n">coeff</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
                <span class="n">new_op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">_StrWrapper</span><span class="p">(</span><span class="n">new_op</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">op</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;array&quot;</span><span class="p">:</span>
                <span class="n">new_op</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">coeff</span><span class="p">)</span>
                <span class="n">new_op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">_CubicSplineWrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tlist</span><span class="p">,</span> <span class="n">new_op</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">op</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;spline&quot;</span><span class="p">:</span>
                <span class="n">new_op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">_Conj</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">get_coeff</span><span class="p">)</span>
                <span class="n">new_op</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">new_op</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;func&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s2">&quot;mixed_callable&quot;</span>
            <span class="n">new_ops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">EvoElement</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="n">new_op</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ops</span> <span class="o">=</span> <span class="n">new_ops</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">expect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">herm</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The time need to be a real scalar&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">Qobj</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cte</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">state</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">vec</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">full</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="s2">&quot;F&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cte</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">state</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                <span class="n">vec</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">full</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="s2">&quot;F&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Dimensions do not fit&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">vec</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The vector must be an array or Qobj&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">vec</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">cte</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiled</span><span class="p">:</span>
                <span class="n">exp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">vec</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cte</span><span class="o">.</span><span class="n">issuper</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dynamics_args_update</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
                <span class="n">exp</span> <span class="o">=</span> <span class="n">cy_expect_rho_vec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">vec</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dynamics_args_update</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
                <span class="n">exp</span> <span class="o">=</span> <span class="n">cy_expect_psi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">vec</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">vec</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">cte</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiled</span><span class="p">:</span>
                <span class="n">exp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span><span class="o">.</span><span class="n">overlapse</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">vec</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dynamics_args_update</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
                <span class="n">exp</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">*</span>
                       <span class="n">vec</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">cte</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">cte</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The shapes do not match&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">herm</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">exp</span><span class="o">.</span><span class="n">real</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">exp</span>

    <span class="k">def</span> <span class="nf">mul_vec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">vec</span><span class="p">):</span>
        <span class="n">was_Qobj</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;the time need to be a real scalar&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">Qobj</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cte</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">vec</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Dimensions do not fit&quot;</span><span class="p">)</span>
            <span class="n">was_Qobj</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">dims</span> <span class="o">=</span> <span class="n">vec</span><span class="o">.</span><span class="n">dims</span>
            <span class="n">vec</span> <span class="o">=</span> <span class="n">vec</span><span class="o">.</span><span class="n">full</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The vector must be an array or Qobj&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">vec</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The vector must be 1d&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">vec</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cte</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The length do not match&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiled</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span><span class="o">.</span><span class="n">mul_vec</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">vec</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dynamics_args_update</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">vec</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">spmv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">vec</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">was_Qobj</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Qobj</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">dims</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">mul_mat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">mat</span><span class="p">):</span>
        <span class="n">was_Qobj</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;the time need to be a real scalar&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">Qobj</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cte</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">mat</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Dimensions do not fit&quot;</span><span class="p">)</span>
            <span class="n">was_Qobj</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">dims</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">dims</span>
            <span class="n">mat</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">full</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The vector must be an array or Qobj&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mat</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The matrice must be 2d&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cte</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The length do not match&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiled</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span><span class="o">.</span><span class="n">mul_mat</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">mat</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dynamics_args_update</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">mat</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">*</span> <span class="n">mat</span>

        <span class="k">if</span> <span class="n">was_Qobj</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Qobj</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">dims</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">matched</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dense</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">omp</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tidyup</span><span class="p">()</span>
        <span class="n">Code</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiled</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">op</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamics_args</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">QobjEvo</span><span class="p">):</span>
                <span class="n">op</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">matched</span><span class="p">,</span> <span class="n">dense</span><span class="p">,</span> <span class="n">omp</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">qset</span><span class="o">.</span><span class="n">has_openmp</span><span class="p">:</span>
            <span class="n">omp</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">omp</span><span class="p">:</span>
            <span class="n">nnz</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cte</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">nnz</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">:</span>
                <span class="n">nnz</span> <span class="o">+=</span> <span class="p">[</span><span class="n">part</span><span class="o">.</span><span class="n">qobj</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">nnz</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">qset</span><span class="o">.</span><span class="n">openmp_thresh</span> <span class="o">&lt;</span> <span class="n">nz</span> <span class="k">for</span> <span class="n">nz</span> <span class="ow">in</span> <span class="n">nnz</span><span class="p">):</span>
                <span class="n">omp</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dense</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span> <span class="o">=</span> <span class="n">CQobjCteDense</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compiled</span> <span class="o">=</span> <span class="s2">&quot;dense single cte&quot;</span>
            <span class="k">elif</span> <span class="n">omp</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span> <span class="o">=</span> <span class="n">CQobjCteOmp</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compiled</span> <span class="o">=</span> <span class="s2">&quot;csr omp cte&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span><span class="o">.</span><span class="n">set_threads</span><span class="p">(</span><span class="n">omp</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">omp</span> <span class="o">=</span> <span class="n">omp</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span> <span class="o">=</span> <span class="n">CQobjCte</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compiled</span> <span class="o">=</span> <span class="s2">&quot;csr single cte&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cte</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">matched</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">omp</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span> <span class="o">=</span> <span class="n">CQobjEvoTdMatchedOmp</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">compiled</span> <span class="o">=</span> <span class="s2">&quot;matched omp &quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span><span class="o">.</span><span class="n">set_threads</span><span class="p">(</span><span class="n">omp</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">omp</span> <span class="o">=</span> <span class="n">omp</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span> <span class="o">=</span> <span class="n">CQobjEvoTdMatched</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">compiled</span> <span class="o">=</span> <span class="s2">&quot;matched single &quot;</span>
            <span class="k">elif</span> <span class="n">dense</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span> <span class="o">=</span> <span class="n">CQobjEvoTdDense</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compiled</span> <span class="o">=</span> <span class="s2">&quot;dense single &quot;</span>
            <span class="k">elif</span> <span class="n">omp</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span> <span class="o">=</span> <span class="n">CQobjEvoTdOmp</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compiled</span> <span class="o">=</span> <span class="s2">&quot;csr omp &quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span><span class="o">.</span><span class="n">set_threads</span><span class="p">(</span><span class="n">omp</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">omp</span> <span class="o">=</span> <span class="n">omp</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span> <span class="o">=</span> <span class="n">CQobjEvoTd</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compiled</span> <span class="o">=</span> <span class="s2">&quot;csr single &quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cte</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span><span class="o">.</span><span class="n">has_dyn_args</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamics_args</span><span class="p">))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;func&quot;</span><span class="p">]:</span>
                <span class="n">funclist</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">:</span>
                    <span class="n">funclist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">part</span><span class="o">.</span><span class="n">get_coeff</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coeff_get</span> <span class="o">=</span> <span class="n">_UnitedFuncCaller</span><span class="p">(</span><span class="n">funclist</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span>
                                                   <span class="bp">self</span><span class="o">.</span><span class="n">dynamics_args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cte</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compiled</span> <span class="o">+=</span> <span class="s2">&quot;pyfunc&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span><span class="o">.</span><span class="n">set_factor</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">coeff_get</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;mixed_callable&quot;</span><span class="p">]:</span>
                <span class="n">funclist</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">part</span><span class="o">.</span><span class="n">get_coeff</span><span class="p">,</span> <span class="n">_StrWrapper</span><span class="p">):</span>
                        <span class="n">part</span><span class="o">.</span><span class="n">get_coeff</span><span class="p">,</span> <span class="n">file</span> <span class="o">=</span> <span class="n">_compile_str_single</span><span class="p">(</span><span class="n">part</span><span class="o">.</span><span class="n">coeff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
                        <span class="n">coeff_files</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
                    <span class="n">funclist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">part</span><span class="o">.</span><span class="n">get_coeff</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coeff_get</span> <span class="o">=</span> <span class="n">_UnitedFuncCaller</span><span class="p">(</span><span class="n">funclist</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span>
                                                   <span class="bp">self</span><span class="o">.</span><span class="n">dynamics_args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cte</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compiled</span> <span class="o">+=</span> <span class="s2">&quot;pyfunc&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span><span class="o">.</span><span class="n">set_factor</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">coeff_get</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="s2">&quot;mixed_compilable&quot;</span><span class="p">]:</span>
                <span class="c1"># All factor can be compiled</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coeff_get</span><span class="p">,</span> <span class="n">Code</span><span class="p">,</span> <span class="n">file</span> <span class="o">=</span> <span class="n">_compiled_coeffs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">,</span>
                                                              <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span>
                                                              <span class="bp">self</span><span class="o">.</span><span class="n">dynamics_args</span><span class="p">,</span>
                                                              <span class="bp">self</span><span class="o">.</span><span class="n">tlist</span><span class="p">)</span>
                <span class="n">coeff_files</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span><span class="o">.</span><span class="n">set_factor</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">coeff_get</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compiled</span> <span class="o">+=</span> <span class="s2">&quot;cyfactor&quot;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;array&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tlist</span><span class="p">),</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">tlist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">coeff_get</span> <span class="o">=</span> <span class="n">InterCoeffCte</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">tlist</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">coeff_get</span> <span class="o">=</span> <span class="n">InterCoeffT</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tlist</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compiled</span> <span class="o">+=</span> <span class="s2">&quot;cyfactor&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span><span class="o">.</span><span class="n">set_factor</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">coeff_get</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;spline&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coeff_get</span> <span class="o">=</span> <span class="n">InterpolateCoeff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compiled</span> <span class="o">+=</span> <span class="s2">&quot;cyfactor&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span><span class="o">.</span><span class="n">set_factor</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">coeff_get</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">coeff_files</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">code</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Code</span>

    <span class="k">def</span> <span class="nf">_get_coeff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">part</span><span class="o">.</span><span class="n">get_coeff</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_dict_</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                  <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s2">&quot;compiled_qobjevo&quot;</span><span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiled</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">_dict_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span><span class="o">.</span><span class="n">__getstate__</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">_dict_</span><span class="p">,)</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiled</span><span class="p">:</span>
            <span class="n">mat_type</span><span class="p">,</span> <span class="n">threading</span><span class="p">,</span> <span class="n">td</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">compiled</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">mat_type</span> <span class="o">==</span> <span class="s2">&quot;csr&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">safePickle</span><span class="p">:</span>
                    <span class="c1"># __getstate__ and __setstate__ of compiled_qobjevo pass pointers</span>
                    <span class="c1"># In &#39;safe&#39; mod, these pointers are not used.</span>
                    <span class="k">if</span> <span class="n">td</span> <span class="o">==</span> <span class="s2">&quot;cte&quot;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">threading</span> <span class="o">==</span> <span class="s2">&quot;single&quot;</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span> <span class="o">=</span> <span class="n">CQobjCte</span><span class="p">()</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cte</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">threading</span> <span class="o">==</span> <span class="s2">&quot;omp&quot;</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span> <span class="o">=</span> <span class="n">CQobjCteOmp</span><span class="p">()</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cte</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span><span class="o">.</span><span class="n">set_threads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">omp</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># time dependence is pyfunc or cyfactor</span>
                        <span class="k">if</span> <span class="n">threading</span> <span class="o">==</span> <span class="s2">&quot;single&quot;</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span> <span class="o">=</span> <span class="n">CQobjEvoTd</span><span class="p">()</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cte</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">threading</span> <span class="o">==</span> <span class="s2">&quot;omp&quot;</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span> <span class="o">=</span> <span class="n">CQobjEvoTdOmp</span><span class="p">()</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cte</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span><span class="o">.</span><span class="n">set_threads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">omp</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">td</span> <span class="o">==</span> <span class="s2">&quot;pyfunc&quot;</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span><span class="o">.</span><span class="n">set_factor</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">coeff_get</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">td</span> <span class="o">==</span> <span class="s2">&quot;cyfactor&quot;</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span><span class="o">.</span><span class="n">set_factor</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">coeff_get</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">td</span> <span class="o">==</span> <span class="s2">&quot;cte&quot;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">threading</span> <span class="o">==</span> <span class="s2">&quot;single&quot;</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span> <span class="o">=</span> <span class="n">CQobjCte</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">CQobjCte</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">threading</span> <span class="o">==</span> <span class="s2">&quot;omp&quot;</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span> <span class="o">=</span> <span class="n">CQobjCteOmp</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">CQobjCteOmp</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span><span class="o">.</span><span class="n">set_threads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">omp</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># time dependence is pyfunc or cyfactor</span>
                        <span class="k">if</span> <span class="n">threading</span> <span class="o">==</span> <span class="s2">&quot;single&quot;</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span> <span class="o">=</span> <span class="n">CQobjEvoTd</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">CQobjEvoTd</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">threading</span> <span class="o">==</span> <span class="s2">&quot;omp&quot;</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span> <span class="o">=</span> <span class="n">CQobjEvoTdOmp</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">CQobjEvoTdOmp</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span><span class="o">.</span><span class="n">set_threads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">omp</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span><span class="o">.</span><span class="n">__setstate__</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

            <span class="k">elif</span> <span class="n">mat_type</span> <span class="o">==</span> <span class="s2">&quot;dense&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">td</span> <span class="o">==</span> <span class="s2">&quot;cte&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span> <span class="o">=</span> \
                        <span class="n">CQobjCteDense</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">CQobjCteDense</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">CQobjEvoTdDense</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">CQobjEvoTdDense</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span><span class="o">.</span><span class="n">__setstate__</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

            <span class="k">elif</span> <span class="n">mat_type</span> <span class="o">==</span> <span class="s2">&quot;matched&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">threading</span> <span class="o">==</span> <span class="s2">&quot;single&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span> <span class="o">=</span> \
                        <span class="n">CQobjEvoTdMatched</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">CQobjEvoTdMatched</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">threading</span> <span class="o">==</span> <span class="s2">&quot;omp&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span> <span class="o">=</span> \
                        <span class="n">CQobjEvoTdMatchedOmp</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">CQobjEvoTdMatchedOmp</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span><span class="o">.</span><span class="n">set_threads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">omp</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compiled_qobjevo</span><span class="o">.</span><span class="n">__setstate__</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></div>


<span class="c1"># Function defined inside another function cannot be pickled,</span>
<span class="c1"># Using class instead</span>
<span class="k">class</span> <span class="nc">_UnitedFuncCaller</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">funclist</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">dynamics_args</span><span class="p">,</span> <span class="n">cte</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">funclist</span> <span class="o">=</span> <span class="n">funclist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamics_args</span> <span class="o">=</span> <span class="n">dynamics_args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dims</span> <span class="o">=</span> <span class="n">cte</span><span class="o">.</span><span class="n">dims</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">cte</span><span class="o">.</span><span class="n">shape</span>

    <span class="k">def</span> <span class="nf">set_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">dynamics_args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamics_args</span> <span class="o">=</span> <span class="n">dynamics_args</span>

    <span class="k">def</span> <span class="nf">dyn_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">shape</span><span class="p">):</span>
        <span class="c1"># 1d array are to F ordered</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s2">&quot;F&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">op</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamics_args</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;vec&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span>
            <span class="k">elif</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;mat&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat</span>
            <span class="k">elif</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;Qobj&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>  <span class="c1"># oper</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Qobj</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Qobj</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">]])</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># rho</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Qobj</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;expect&quot;</span><span class="p">:</span>  <span class="c1"># ket</span>
                <span class="k">if</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">op</span><span class="o">.</span><span class="n">cte</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="c1"># same shape as object</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">mul_mat</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">mat</span><span class="p">)</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">now_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">now_args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">now_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">funclist</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">func</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">now_args</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">get_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span>


<span class="k">class</span> <span class="nc">_Norm2</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">f</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">args</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">_Conj</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">f</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">args</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">_Prod</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func_1</span> <span class="o">=</span> <span class="n">f</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func_2</span> <span class="o">=</span> <span class="n">g</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">func_1</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">func_2</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_Add</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">funcs</span> <span class="o">=</span> <span class="n">fs</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">f</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">funcs</span><span class="p">])</span>

<span class="kn">from</span> <span class="nn">qutip.superoperator</span> <span class="k">import</span> <span class="n">vec2mat</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2011 and later, P.D. Nation, J.R. Johansson, A.J.G. Pitchford, C. Granade, A.L. Grimsmo, N. Shammah, S. Ahmed, N. Lambert, and E. Giguere
      <span class="lastupdated">
        Last updated on Jul 02, 2019.
      </span>

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>